<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luther's Small Catechism Translation Tool</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Crect x='0' y='0' width='120' height='120' rx='20' fill='white'/%3E%3Cg transform='translate(60,60) scale(2) translate(-60,-60)'%3E%3Cpath fill='%23355258' d='M61.8,43.1l-2.6,2.6L57,43.6c-6-6-15.6-6-21.6,0c-6,6-6,15.6,0,21.6l2.2,2.2l21.6,21.6l21.6-21.6l2.6-2.6c6-6,6-15.6,0-21.6C77.5,37.2,67.8,37.2,61.8,43.1z M70.1,64.6h-6.9v6.9h-6.5v-6.9h-6.9v-6.5h6.9v-6.9h6.5v6.9h6.9V64.6z'/%3E%3C/g%3E%3C/svg%3E">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="translations-data.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
const { useState, useEffect } = React;

// Lucide React icon components (simplified versions)
const Download = ({ size = 24, className = "" }) => (
  <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
  </svg>
);

const FileText = ({ size = 24, className = "" }) => (
  <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
    <polyline points="14 2 14 8 20 8"/>
    <line x1="16" y1="13" x2="8" y2="13"/>
    <line x1="16" y1="17" x2="8" y2="17"/>
    <polyline points="10 9 9 9 8 9"/>
  </svg>
);

const X = ({ size = 24, className = "" }) => (
  <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <line x1="18" y1="6" x2="6" y2="18"/>
    <line x1="6" y1="6" x2="18" y2="18"/>
  </svg>
);

const HelpCircle = ({ size = 24, className = "" }) => (
  <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <circle cx="12" cy="12" r="10"/>
    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
    <line x1="12" y1="17" x2="12.01" y2="17" strokeLinecap="round"/>
  </svg>
);

const Trash = ({ size = 24, className = "" }) => (
  <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <polyline points="3 6 5 6 21 6"/>
    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
  </svg>
);

const CPHLogo = ({ size = 48 }) => (
  <svg width={size} height={size} viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
    <g>
      <path fill="currentColor" d="M119,63c-0.7-3.5-2.7-10.2-3.5-12.2c-1.9-4.7,1.6-10.6,1.6-10.6s-5.3-1.6-7.3-5.5 c-2.1-3.8-3.6-9.5-4.8-12.6c-1.2-3.1-2.9-6.1-7.9-6.3c-0.1,0-0.2,0-0.2,0c-3.2,0-5.3,2.5-6.4,4.9c-0.2,0.4-0.3,0.8-0.5,1.3 c-1.3-1-2.6-2-4-2.8c2.3-2.7,4.2-6.5,1.7-10.5c-2.2-3.5-8.5-2.9-12-3c-0.8,0-1.8,0-2.9,0c-0.1,0-0.2,0-0.3,0c-3.3,0-7.2,0-9.2-1.2 c-2.7-1.6-3.6-2.9-3.6-2.9s-2.2,3.3-5.2,3.8c-2.5,0.4-13.4,0.7-15.3,0.9c-1.9,0.2-9,2.3-8.2,8.8c0.2,1.8,0.9,3.2,1.9,4.3 c-1.1,0.7-2.2,1.5-3.3,2.3c-1.2-1.8-2.7-3.3-4.6-4c-1.2-0.4-2.3-0.6-3.4-0.6c-3.1,0-5.7,2.1-8.5,8.7c-3.3,7.7-3.3,8.6-5.4,11.5 c-2.5,3.5-6.2,4.2-6.2,4.2s3.2,4,2.9,8.7c-0.4,6.3-6.2,16.9-2.4,23.2c1.4,2.4,3.5,3.2,5.5,3.2c1.7,0,3.4-0.5,4.7-1.1 c0.4,1.3,0.8,2.6,1.3,3.8c-3.1,1.1-6.7,2.7-6.9,7.9c-0.1,3.5,3.3,5.6,4.4,6.4c1,0.8,10.4,6.3,12.4,9.5c1.4,2.2,1.5,5.2,1.5,5.2 s0.3,0,0.7,0c1.4,0,4.7,0.1,6.8,0.7c2.7,0.8,8.2,4.3,12,6.7c2.8,1.8,5.6,2.7,7.7,2.7c0.7,0,1.3-0.1,1.8-0.4c1.8-1,3.7-2.2,4.1-5.5 c0.1-0.7,0.1-1.4,0.1-2.1c0.5,0,1.1,0,1.6,0c1,0,2.1,0,3.1-0.1c0,0.3-0.1,0.6,0,0.9c0.1,2.5,0.5,7.1,5,7.1c0.2,0,0.3,0,0.5,0 c4.6-0.3,6.7-2.2,8.8-3.5c2.1-1.3,8.5-5.5,11.5-6.8c1.1-0.5,2.9-0.6,4.5-0.6c2.3,0,4.4,0.3,4.4,0.3s-0.3-5.9,2.5-8.6 c2.9-2.7,9.8-7.8,11.9-10.1c2.2-2.3,4.3-6.2-0.1-9.9c-1.6-1.4-3.4-2.1-5.2-2.5c0.6-1.8,1.1-3.5,1.5-5.4c2,1,4,1.7,5.7,1.7 c0.6,0,1.2-0.1,1.8-0.3C120.3,70.3,119.7,66.5,119,63z M88.5,26.4c-0.9,2.5-2,5.1-3.7,6.4c-0.8,0.6-1.9,1-3.1,1 c-2.5,0-4.9-1.7-3.9-5.6c0.6-2.3,2.7-4.2,4.1-5.2c0.2-0.1,0.5-0.3,0.8-0.6C84.8,23.5,86.7,24.9,88.5,26.4z M36,22.3 c0.2,0.1,0.3,0.3,0.5,0.4c2.4,2,5.2,3.7,5.2,7.5c0,2.1-0.7,2.7-2,3.2c-0.5,0.2-1.2,0.4-2,0.4c-1.4,0-3.1-0.6-4.1-2.9 c-0.6-1.4-1.3-3.4-2.2-5.4C32.8,24.3,34.4,23.3,36,22.3z M17.5,78.1c-0.7-1.6-1.2-3.2-1.7-4.9c3.2-2.1,7.2-4.7,9.6-4.7 c0.1,0,0.1,0,0.2,0c2.9,0.2,5.1,4.3,1.9,6.6C24.3,77.3,20.8,77.4,17.5,78.1z M59.4,106.3c-0.7,0-1.5,0-2.2-0.1 c-0.3-1.3-0.6-2.7-0.9-4.1c-0.7-3.8,0.7-7,3.9-7.1c0,0,0.1,0,0.1,0c3.1,0,4.3,2.5,4.1,5.4c-0.1,1.5-0.6,3.6-1.1,5.7 C62,106.2,60.7,106.3,59.4,106.3z M102.1,76c-1.3-0.1-2.7-0.3-4.1-0.6c-5.3-1.2-8.1-4.4-7.7-6.7c0.4-2.1,2.4-3.3,4.7-3.3 c1,0,2,0.2,3,0.6c1.6,0.6,3.6,1.9,5.9,3.1C103.5,71.5,102.8,73.8,102.1,76z M115.2,67.3c-0.1,0.2-0.2,0.8-1.6,1.4c0,0-0.1,0-0.1,0 c-0.4,0-1.4-0.1-3.5-1.1c-0.5-0.2-1-0.5-1.4-0.7c-1.3-0.7-2.6-1.4-3.9-2.1c0,0-0.1,0-0.1-0.1c-1.8-1-3.4-1.9-4.8-2.5 c-1.5-0.6-3.1-0.9-4.6-0.9c-2,0-3.9,0.5-5.4,1.6c-1.8,1.2-3,3.1-3.4,5.2c-0.5,2.6,0.6,5.4,2.9,7.6c2,1.9,4.8,3.3,8,4 c1.2,0.3,2.3,0.4,3.3,0.5c0.5,0.1,0.9,0.1,1.4,0.1c1.1,0.1,2.1,0.2,3,0.4c1.6,0.3,2.8,0.7,4,1.7c0.7,0.6,1.1,1.1,1.1,1.5 c0,0.4-0.3,1.2-1.3,2.3c-1,1-3.5,3.1-5.7,4.9c-2.4,1.9-4.6,3.7-6.1,5.1c-1.8,1.7-2.9,4.1-3.5,7.2c-0.2,0-0.4,0-0.6,0 c-2.7,0-4.7,0.3-6.2,1c-2.5,1.1-6.6,3.7-9.7,5.6c-0.9,0.6-1.7,1.1-2.2,1.4c-0.4,0.3-0.8,0.5-1.2,0.8c-1.7,1.1-3,1.9-5.7,2.1 c-0.1,0-0.1,0-0.2,0c-0.2,0-0.3,0-0.3,0c-0.1-0.2-0.5-0.8-0.5-3c0-0.3,0.1-0.7,0.2-1.2c0.2-1,0.5-2.2,0.7-3.2 c0.1-0.4,0.2-0.8,0.3-1.2c0.4-1.7,0.8-3.4,0.8-4.9c0.1-3-0.7-5.6-2.4-7.4c-1.9-2-4.3-2.4-5.9-2.4c-0.1,0-0.1,0-0.2,0 c-2.4,0-4.6,1.1-6.1,2.9c-1.8,2.3-2.5,5.6-1.8,9.1c0.2,0.9,0.4,1.8,0.5,2.6c0,0.1,0,0.2,0.1,0.3c0.3,1.6,0.6,3,0.7,4.3 c0.1,0.7,0.1,1.3,0,2c-0.1,0.8-0.3,1.1-0.5,1.3c-0.3,0.3-0.7,0.6-1.2,0.9c0,0,0,0,0,0c-1.1,0-3.2-0.6-5.4-2.1 c-6-3.9-10.3-6.4-13.1-7.2c-1.5-0.4-3.4-0.7-5.1-0.8c-0.3-1.1-0.8-2.2-1.5-3.3c-1.7-2.7-5.6-5.5-11.7-9.4c-0.6-0.4-1.4-0.9-1.6-1 c-0.2-0.1-0.4-0.3-0.6-0.4c-0.7-0.5-2.3-1.7-2.2-2.5c0.1-2.4,1-3.1,4.5-4.3c0.1,0,0.2-0.1,0.3-0.1c0.3-0.1,0.5-0.2,0.8-0.3 c0.9-0.3,1.9-0.5,3.1-0.7c0.3,0,0.5-0.1,0.8-0.1c2.9-0.5,6.5-1,9.9-3.5c2.7-2,3.9-5.2,2.9-8.3c-0.4-1.5-1.3-2.9-2.5-3.9 c-1.3-1.1-2.9-1.8-4.6-1.9c-0.1,0-0.3,0-0.5,0c-3.1,0-6.4,1.9-10.6,4.6c-0.3,0.2-0.7,0.5-1.1,0.7c-1,0.7-2,1.3-2.7,1.7 c-0.2,0.1-0.3,0.2-0.5,0.3c-1.2,0.5-2.3,0.8-3.2,0.8c-0.9,0-1.4-0.3-1.9-1.1c-1.6-2.6,0-8.1,1.2-12.5c0.8-2.9,1.6-5.7,1.8-8.3 c0.2-2.7-0.4-5.1-1.2-7.1c1.3-0.9,2.6-2,3.7-3.6c1.8-2.4,2.3-3.8,3.6-6.9c0.6-1.4,1.3-3.1,2.3-5.5c1.2-2.7,2.2-4.5,3.2-5.5 c0.6-0.6,1-0.7,1.4-0.7c0.5,0,1.2,0.1,2.1,0.4c1,0.3,1.9,1.4,2.6,2.7c0.7,1.2,1.3,2.7,1.9,4c0.2,0.5,0.4,0.9,0.5,1.3 c0.4,1,0.8,2,1.2,2.9c1.6,3.4,4.4,5.3,7.9,5.3c1.7,0,3-0.5,3.6-0.7c1-0.4,2.3-1.1,3.2-2.5c0.9-1.2,1.3-2.7,1.3-4.6 c0-2.4-0.7-4.5-2.2-6.4c-1.1-1.5-2.4-2.5-3.6-3.5c0,0-0.1,0-0.1-0.1c-0.3-0.2-0.6-0.4-0.8-0.7c-0.4-0.3-0.8-0.6-1.1-0.9 c-0.6-0.5-1.2-1-1.6-1.3c-0.9-0.9-1.4-1.6-1.5-2.6c-0.1-0.9,0-1.9,1.4-2.9c1.2-0.8,2.7-1.3,3.2-1.3c0.6-0.1,3.4-0.2,5.6-0.3 c4.9-0.2,8.2-0.4,9.8-0.6c1.9-0.3,3.5-1.2,4.8-2.2c0.4,0.2,0.7,0.5,1.2,0.7c2.8,1.7,6.7,1.8,11.4,1.8h0.3c0.9,0,1.9,0,2.7,0 c0.7,0,1.4,0,2.2,0c1.6,0,3.4,0,4.8,0.3c1,0.2,1.6,0.5,1.7,0.7c0.4,0.7,0.6,1.3,0.5,2.1c-0.1,0.7-0.5,1.6-1.1,2.5 c-0.4,0.5-0.8,1.1-1.2,1.5c-1,1-2,1.9-2.6,2.3c-0.2,0.2-0.5,0.4-0.9,0.7c-1.6,1.3-4.1,3.7-4.9,7c-0.8,3-0.3,5.7,1.3,7.8 c1.5,2,4,3.1,6.7,3.1c2.1,0,4.1-0.7,5.6-1.9c2.1-1.6,3.4-4.1,4.4-6.6c0.6-1.4,1-2.8,1.4-4.1c0-0.1,0.1-0.2,0.1-0.3 c0.3-1,0.6-2,0.9-2.5c0.4-0.8,0.9-1.5,1.4-2c0.5-0.4,0.9-0.5,1.2-0.5c0,0,0.1,0,0.1,0c1.8,0.1,2.4,0.7,2.7,0.9 c0.6,0.6,1.1,1.7,1.5,2.8c0.4,0.9,0.8,2.2,1.2,3.5c1,3,2.2,6.7,3.8,9.6c1.4,2.5,3.6,4.3,5.6,5.5c-0.9,2.8-1.4,6.5,0,10 c0.7,1.8,2.7,8.2,3.3,11.4C115.1,65,115.4,66.4,115.2,67.3z"/>
      <path fill="currentColor" d="M61.8,43.1l-2.6,2.6L57,43.6c-6-6-15.6-6-21.6,0c-6,6-6,15.6,0,21.6l2.2,2.2l21.6,21.6l21.6-21.6l2.6-2.6 c6-6,6-15.6,0-21.6C77.5,37.2,67.8,37.2,61.8,43.1z M70.1,64.6h-6.9v6.9h-6.5v-6.9h-6.9v-6.5h6.9v-6.9h6.5v6.9h6.9V64.6z"/>
    </g>
  </svg>
);

const TranslationWorkstation = () => {
  const [currentFile, setCurrentFile] = useState(null);
  const [translations, setTranslations] = useState({});
  const [fileTitles, setFileTitles] = useState({});
  const [showInstructions, setShowInstructions] = useState(true);
  const [languageCode, setLanguageCode] = useState('');

  // Check for test mode
  const isTestMode = new URLSearchParams(window.location.search).get('test') === 'true';

  // Load saved data
  useEffect(() => {
    const saved = localStorage.getItem('catechism-translations');
    if (saved) setTranslations(JSON.parse(saved));
    
    const savedTitles = localStorage.getItem('catechism-file-titles');
    if (savedTitles) setFileTitles(JSON.parse(savedTitles));
    
    const savedCode = localStorage.getItem('catechism-language-code');
    if (savedCode) setLanguageCode(savedCode);
  }, []);

  // Auto-save
  useEffect(() => {
    if (Object.keys(translations).length > 0) {
      localStorage.setItem('catechism-translations', JSON.stringify(translations));
    }
  }, [translations]);

  useEffect(() => {
    if (Object.keys(fileTitles).length > 0) {
      localStorage.setItem('catechism-file-titles', JSON.stringify(fileTitles));
    }
  }, [fileTitles]);

  useEffect(() => {
    if (languageCode) {
      localStorage.setItem('catechism-language-code', languageCode);
    }
  }, [languageCode]);

  // Set first file on load
  useEffect(() => {
    if (translationFiles) {
      const firstFile = Object.keys(translationFiles)[0];
      setCurrentFile(firstFile);
    }
  }, []);

  const clearProgress = () => {
    if (confirm('Are you sure you want to clear all progress? This cannot be undone.')) {
      localStorage.removeItem('catechism-translations');
      localStorage.removeItem('catechism-file-titles');
      localStorage.removeItem('catechism-language-code');
      setTranslations({});
      setFileTitles({});
      setLanguageCode('');
      alert('Progress cleared!');
    }
  };

  const handleTranslationChange = (fileKey, itemId, value) => {
    setTranslations(prev => ({
      ...prev,
      [fileKey]: {
        ...prev[fileKey],
        [itemId]: value
      }
    }));
  };

  const isFileComplete = (fileKey) => {
    const file = translationFiles[fileKey];
    const fileTranslations = translations[fileKey] || {};
    return file.content.every(item => {
      const value = fileTranslations[item.id];
      return value && (value.trim().length > 0 || value === '[N/A]');
    });
  };

  const getOverallProgress = () => {
    const totalFiles = Object.keys(translationFiles).length;
    const completedCount = Object.keys(translationFiles).filter(isFileComplete).length;
    return Math.round((completedCount / totalFiles) * 100);
  };

  const getFileProgress = (fileKey) => {
    const file = translationFiles[fileKey];
    const fileTranslations = translations[fileKey] || {};
    const completed = file.content.filter(item => {
      const value = fileTranslations[item.id];
      return value && (value.trim().length > 0 || value === '[N/A]');
    }).length;
    return Math.round((completed / file.content.length) * 100);
  };

  // Slugify function to convert translated titles to filenames
  const slugify = (text) => {
    return text
      .toString()
      .toLowerCase()
      .trim()
      .replace(/\s+/g, '-')           // Replace spaces with -
      .replace(/[^\w\-Ã¤Ã¶Ã¼ÃŸÃ Ã¡Ã¢Ã£Ã¨Ã©ÃªÃ¬Ã­Ã®Ã²Ã³Ã´ÃµÃ¹ÃºÃ»Ã±Ã§Ä…Ä‡Ä™Å‚Å„Å›ÅºÅ¼ÄÄÄ›ÅˆÅ™Å¡Å¥Å¯Å¾Ã¥Ã¦Ã¸]+/g, '') // Keep accented chars
      .replace(/\-\-+/g, '-')         // Replace multiple - with single -
      .replace(/^-+/, '')             // Trim - from start
      .replace(/-+$/, '');            // Trim - from end
  };

  // YAML conversion function - outputs flat af.yml format
  const generateYAMLContent = (fileKey) => {
    const file = translationFiles[fileKey];
    const fileTranslations = translations[fileKey] || {};
    const langCode = languageCode || 'en';
    
    // Build the YAML object with language code as root
    const yamlData = {};
    yamlData[langCode] = {};
    
    // Separate items by type FIRST so we can check for English translation
    const interfaceItems = [];
    const metadataItems = [];
    const tocItems = [];
    
    file.content.forEach(item => {
      if (item.type === 'interface') interfaceItems.push(item);
      else if (item.type === 'metadata') metadataItems.push(item);
      else if (item.type === 'toc') tocItems.push(item);
    });
    
    // Handle English language name specially
    const englishItem = interfaceItems.find(item => item.yamlKey === 'English');
    if (englishItem) {
      const englishTranslation = fileTranslations[englishItem.id];
      if (englishTranslation && englishTranslation.trim().length > 0 && englishTranslation !== '[N/A]') {
        // User translated "English" - add (English) suffix
        // e.g., "InglÃ©s" becomes "InglÃ©s (English)"
        yamlData[langCode].English = englishTranslation.includes('(English)') 
          ? englishTranslation 
          : `${englishTranslation} (English)`;
      } else {
        // No translation provided, use default
        yamlData[langCode].English = "English";
      }
    } else {
      yamlData[langCode].English = "English";
    }
    
    // Add other language options (these are hardcoded)
    yamlData[langCode].Chinese_Hans = "ä¸­å›½ç®€ä½“";
    yamlData[langCode].Chinese_Hant = "ä¸­åœ‹å‚³çµ±";
    yamlData[langCode].Spanish = "EspaÃ±ol";
    yamlData[langCode].Finnish = "Suomi";
    yamlData[langCode].German = "Deutsch";
    yamlData[langCode].Japanese = "æ—¥æœ¬èªž";
    yamlData[langCode].Tigrigna = "á‰µáŒáˆ­áŠ›";
    yamlData[langCode].Portuguese = "PortuguÃªs";
    
    // Add interface terms (flat key-value) - skip English since we handled it above
    interfaceItems.forEach(item => {
      if (item.yamlKey === 'English') return; // Already handled
      const translation = fileTranslations[item.id];
      if (translation === '[N/A]') return;
      const text = (translation && translation.trim().length > 0) ? translation : item.text;
      yamlData[langCode][item.yamlKey] = text;
    });
    
    // Add metadata section
    if (metadataItems.length > 0) {
      yamlData[langCode].metadata = {};
      metadataItems.forEach(item => {
        const translation = fileTranslations[item.id];
        if (translation === '[N/A]') return;
        const text = (translation && translation.trim().length > 0) ? translation : item.text;
        yamlData[langCode].metadata[item.yamlKey] = text;
      });
    }
    
    // Add contents/TOC section
    if (tocItems.length > 0) {
      yamlData[langCode].contents = {};
      
      // Group TOC items by yamlKey
      const tocGroups = {};
      tocItems.forEach(item => {
        if (!tocGroups[item.yamlKey]) {
          tocGroups[item.yamlKey] = {};
        }
        
        if (item.subKey === 'title') {
          // Use translation for title
          const translation = fileTranslations[item.id];
          if (translation === '[N/A]') return;
          const text = (translation && translation.trim().length > 0) ? translation : item.text;
          tocGroups[item.yamlKey].title = text;
        }
      });
      
      // Generate filenames from translated titles
      Object.keys(tocGroups).forEach(key => {
        const title = tocGroups[key].title;
        if (title) {
          // Special case: preface always uses index.html
          if (key === 'preface') {
            tocGroups[key].filename = 'index.html';
          } else if (key === 'ten_commandments') {
            // Special case: ten_commandments can use index.html OR generated filename
            // If untranslated (still English), use index.html
            // If translated, generate from translation
            if (title === 'The Ten Commandments') {
              tocGroups[key].filename = 'index.html';
            } else {
              tocGroups[key].filename = slugify(title) + '.html';
            }
          } else {
            // Generate filename from translated title
            tocGroups[key].filename = slugify(title) + '.html';
          }
        }
        yamlData[langCode].contents[key] = tocGroups[key];
      });
    }

    return jsyaml.dump(yamlData, {
      indent: 2,
      lineWidth: -1,
      noRefs: true
    });
  };

  // Generate markdown content
  const generateMarkdownContent = (fileKey) => {
    const file = translationFiles[fileKey];
    const fileTranslations = translations[fileKey] || {};
    let content = '';
    
    for (let i = 0; i < file.content.length; i++) {
      const item = file.content[i];
      const translation = fileTranslations[item.id];
      
      if (translation === '[N/A]') continue;
      
      let textToUse;
      if (translation && translation.trim().length > 0) {
        const original = item.text;
        if (original.startsWith('#####')) textToUse = '##### ' + translation;
        else if (original.startsWith('####')) textToUse = '#### ' + translation;
        else if (original.startsWith('###')) textToUse = '### ' + translation;
        else if (original.startsWith('##')) textToUse = '## ' + translation;
        else if (original.startsWith('#')) textToUse = '# ' + translation;
        else if (original.startsWith('_') && original.endsWith('_')) textToUse = '_' + translation + '_';
        else textToUse = translation;
      } else {
        textToUse = item.text;
      }
      
      const nextItem = file.content[i + 1];
      const isInlineQuestion = item.type === 'question' && item.text.trim().startsWith('_') && item.text.includes('?');
      const nextIsAnswer = nextItem && (nextItem.type === 'answer' || nextItem.type === 'text');

      if (isInlineQuestion && nextIsAnswer) {
        content += textToUse + ' ';
      } else {
        content += textToUse + '\n\n';
      }
    }
    
    return content.trim();
  };

  // Smart download function
  const downloadFile = (fileKey) => {
    const file = translationFiles[fileKey];
    const fileTranslations = translations[fileKey] || {};
    
    // Determine if this is App Interface Terms
    const isAppInterface = fileKey === 'app-interface';
    
    // Get title
    let titleToUse;
    if (fileTitles[fileKey] && fileTitles[fileKey].trim()) {
      titleToUse = fileTitles[fileKey];
    } else {
      const firstTranslation = fileTranslations[file.content[0]?.id];
      titleToUse = firstTranslation || file.title;
    }
    
    let content, filename, mimeType;
    
    if (isAppInterface && languageCode) {
      // Generate YAML
      content = generateYAMLContent(fileKey);
      filename = `${languageCode}.yml`;
      mimeType = 'text/yaml';
    } else {
      // Generate Markdown
      content = generateMarkdownContent(fileKey);
      filename = titleToUse.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-') + '.md';
      mimeType = 'text/markdown';
    }
    
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  };

  const downloadAllCompleted = () => {
    Object.keys(translationFiles).forEach((fileKey, index) => {
      if (isFileComplete(fileKey)) {
        setTimeout(() => downloadFile(fileKey), index * 200);
      }
    });
  };

  // Test mode functions
  const autoFillEnglish = (fileKey) => {
    const file = translationFiles[fileKey];
    const newTranslations = {...(translations[fileKey] || {})};
    
    file.content.forEach(item => {
      const cleanText = item.text
        .replace(/^#{1,5}\s*\*?\s*/g, '')
        .replace(/_/g, '')
        .replace(/\\n/g, ' ');
      newTranslations[item.id] = cleanText;
    });
    
    setTranslations({
      ...translations,
      [fileKey]: newTranslations
    });
    
    setFileTitles({
      ...fileTitles,
      [fileKey]: file.title
    });
    
    alert('Auto-filled with English text!');
  };

  const autoFillAllEnglish = () => {
    const allTranslations = {};
    const allTitles = {};
    
    Object.keys(translationFiles).forEach(fileKey => {
      const file = translationFiles[fileKey];
      allTranslations[fileKey] = {};
      allTitles[fileKey] = file.title;
      
      file.content.forEach(item => {
        const cleanText = item.text
          .replace(/^#{1,5}\s*/g, '')
          .replace(/_/g, '')
          .replace(/\\n/g, ' ');
        allTranslations[fileKey][item.id] = cleanText;
      });
    });
    
    setTranslations(allTranslations);
    setFileTitles(allTitles);
    setLanguageCode('test');
    alert('All files auto-filled with English text!');
  };

  const generateTextContent = (fileKey) => {
    const file = translationFiles[fileKey];
    let content = `${file.title}\n\n`;
    content += `Category: ${file.category}\n\n`;
    content += `============================================================\n`;
    content += `OFFLINE TRANSLATION INSTRUCTIONS\n`;
    content += `============================================================\n\n`;
    content += `1. Translate each section below into your target language\n`;
    content += `2. Keep the section numbers (Section 1, Section 2, etc.) - do NOT translate these\n`;
    content += `3. Translate only the text content\n`;
    content += `4. When done, copy your translations back into the web tool\n`;
    content += `5. The web tool will automatically format your translations\n`;
    content += `6. Then download the final .md files from the tool\n`;
    content += `7. Email completed .md files to: jeremy.roegner@cph.org\n\n`;
    content += `============================================================\n\n`;

    file.content.forEach((item, index) => {
      let cleanText = item.text
        .replace(/^#{1,5}\s*/g, '')
        .replace(/_/g, '')
        .replace(/\\n/g, item.type === 'description' ? '\n' : ' ');
      
      content += `Section ${index + 1} (Type: ${item.type})\n\n`;
      content += `ORIGINAL TEXT:\n${cleanText}\n\n`;
      content += `YOUR TRANSLATION:\n\n\n`;
      content += `------------------------------------------------------------\n\n`;
    });

    content += `============================================================\n`;
    content += `END OF FILE\n`;
    content += `============================================================\n`;

    return content;
  };

  const downloadAllTextFiles = async () => {
    const JSZip = window.JSZip;
    const zip = new JSZip();
    
    Object.keys(translationFiles).forEach(fileKey => {
      const content = generateTextContent(fileKey);
      const file = translationFiles[fileKey];
      const filename = file.title.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '-') + '.txt';
      zip.file(filename, content);
    });
    
    const blob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'catechism-translation-files.zip';
    a.click();
    URL.revokeObjectURL(url);
  };

  if (!currentFile || !translationFiles) return <div className="p-6">Loading translation data...</div>;

  const file = translationFiles[currentFile];
  const fileTranslations = translations[currentFile] || {};
  const fileProgress = getFileProgress(currentFile);
  const overallProgress = getOverallProgress();
  const isAppInterface = currentFile === 'app-interface';
  const categories = ['Catechism', 'App Content'];

  return (
    <div className="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
      <div className="bg-white rounded-lg shadow-lg overflow-hidden">
        {/* Header */}
        <div className="bg-blue-600 text-white p-6">
          <div className="flex items-center gap-4 mb-2">
            <div className="bg-white rounded-lg p-2">
              <div className="text-blue-600">
                <CPHLogo size={48} />
              </div>
            </div>
            <div>
              <h1 className="text-3xl font-bold">Luther's Small Catechism</h1>
              <p className="text-blue-100">TRANSLATION TOOL</p>
            </div>
          </div>
        </div>

        {/* Instructions */}
        {showInstructions && (
          <div className="bg-yellow-50 border-b border-yellow-200 p-4">
            <div className="flex items-start justify-between">
              <div className="flex items-start gap-3">
                <HelpCircle size={20} className="text-yellow-600 mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <h3 className="font-semibold text-yellow-800 mb-2">Quick Start Guide</h3>
                  <div className="text-sm text-yellow-700 space-y-2">
                    <p><strong>1. Choose Workflow:</strong> Work online in this tool OR download offline files (.zip) to translate in a text editor.</p>
                    <p><strong>2. Translate Online:</strong> Select a file from the sidebar, enter translated file title, and translate each section. Progress autosaves!</p>
                    <p><strong>3. Mark N/A:</strong> Check "Mark as Not Applicable" for sections that don't apply to your languageâ€”they'll be excluded from download.</p>
                    <p><strong>4. Language Code:</strong> For App Interface Terms, enter your language code (e.g., 'es', 'de', 'zh'). File will download as {languageCode || 'code'}.yml instead of .md</p>
                    <p><strong>5. Download:</strong> When a file is 100% complete, the download button will activate. Click "Download" for each file individually, or click "Download All Completed Files" at the top for batch download.</p>
                    <p><strong>6. Preview:</strong> Visit <a href="https://catechism.cph.org" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">catechism.cph.org</a> to see an example of the final product</p>
                    <p><strong>7. Questions?</strong> Contact Jeremy Roegner at <a href="mailto:jeremy.roegner@cph.org" className="text-blue-600 hover:underline">jeremy.roegner@cph.org</a></p>
                    <p><strong>8. Submit:</strong> Email completed .md/.yml files to <a href="mailto:jeremy.roegner@cph.org" className="text-blue-600 hover:underline">jeremy.roegner@cph.org</a></p>
                    <p className="text-xs italic mt-2">Note: Translations autosave as you work. Use "Clear All" to reset everything and start over.</p>
                  </div>
                </div>
              </div>
              <button onClick={() => setShowInstructions(false)} className="text-yellow-600 p-1 hover:bg-yellow-100 rounded flex-shrink-0">
                <X size={20} />
              </button>
            </div>
          </div>
        )}

        {/* Progress section */}
        <div className="bg-blue-50 border-b p-4">
          <div className="mb-4 pb-4 border-b border-gray-300">
            <h3 className="text-sm font-semibold text-gray-700 mb-2">Offline Translation</h3>
            <p className="text-xs text-gray-600 mb-2">Download files to translate offline in a text editor</p>
            <button onClick={downloadAllTextFiles} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
              <FileText size={16} />
              Download Offline Files (.zip)
            </button>
          </div>

          <div>
            <h3 className="text-sm font-semibold text-gray-700 mb-2">Translation Progress</h3>
            <div className="flex gap-3 flex-wrap">
              <button onClick={clearProgress} className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 flex items-center gap-2">
                <Trash size={16} />
                Clear All
              </button>
              <button
                onClick={downloadAllCompleted}
                disabled={overallProgress < 100}
                className={'px-4 py-2 rounded font-semibold flex items-center gap-2 ' + (overallProgress === 100 ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-500')}
              >
                <Download size={16} />
                Download All Completed Files
              </button>
              
              {isTestMode && (
                <>
                  <button
                    onClick={() => autoFillEnglish(currentFile)}
                    className="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 flex items-center gap-2"
                  >
                    ðŸ§ª Fill Current File (Test)
                  </button>
                  <button
                    onClick={autoFillAllEnglish}
                    className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 flex items-center gap-2"
                  >
                    ðŸ§ª Fill All Files (Test)
                  </button>
                </>
              )}
            </div>
          </div>
        </div>

        <div className="flex">
          {/* Sidebar */}
          <div className="w-1/3 bg-gray-100 p-4">
            <div className="mb-4">
              <h3 className="font-semibold mb-2">Progress: {overallProgress}%</h3>
              <div className="bg-gray-200 rounded h-3">
                <div className="bg-green-500 h-3 rounded" style={{ width: overallProgress + '%' }}></div>
              </div>
            </div>

            {categories.map(category => (
              <div key={category} className="mb-4">
                <h3 className="font-semibold mb-2">{category}</h3>
                {Object.entries(translationFiles)
                  .filter(([_, f]) => f.category === category)
                  .map(([key, f]) => (
                    <button
                      key={key}
                      onClick={() => setCurrentFile(key)}
                      className={'w-full text-left p-2 mb-2 rounded border ' + 
                        (currentFile === key ? 'bg-blue-100 border-blue-300' : 
                         isFileComplete(key) ? 'bg-green-50 border-green-300' : 
                         'bg-white border-gray-300')}
                    >
                      <div className="font-medium text-sm">{f.title}</div>
                      <div className="text-xs">{getFileProgress(key)}%</div>
                    </button>
                  ))}
              </div>
            ))}
          </div>

          {/* Main content */}
          <div className="flex-1 p-6">
            <div className="mb-4">
              <h2 className="text-2xl font-bold">{file.title}</h2>
              <button
                onClick={() => downloadFile(currentFile)}
                disabled={fileProgress < 100}
                className={'px-4 py-2 rounded mt-2 ' + (fileProgress === 100 ? 'bg-blue-600 text-white' : 'bg-gray-300')}
              >
                Download {isAppInterface && languageCode ? `as ${languageCode}.yml` : 'as .md'}
              </button>
            </div>

            <div className="space-y-4">
              {/* Language Code Input - Only for App Interface */}
              {isAppInterface && (
                <div className="p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                  <h3 className="font-semibold text-blue-800 mb-2">Language Code (Required for YAML)</h3>
                  <input
                    type="text"
                    value={languageCode}
                    onChange={(e) => setLanguageCode(e.target.value.toLowerCase())}
                    placeholder="e.g., es, de, fr, zh, ja..."
                    className="w-full p-2 border rounded mb-2"
                    maxLength={10}
                  />
                  <p className="text-sm text-blue-700">
                    Enter your ISO 639-1 language code. File will download as <span className="font-mono bg-blue-100 px-1">{languageCode || '[code]'}.yml</span>
                  </p>
                  <p className="text-xs text-blue-600 mt-1">
                    Common codes: es (Spanish), de (German), fr (French), zh (Chinese), ja (Japanese), ko (Korean), pt (Portuguese), ru (Russian)
                  </p>
                </div>
              )}

              {/* File Title Input */}
              <div className="p-4 bg-blue-50 border border-blue-200 rounded">
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Translate the file title: "{file.title}"
                </label>
                <input
                  type="text"
                  value={fileTitles[currentFile] || ''}
                  onChange={(e) => setFileTitles({...fileTitles, [currentFile]: e.target.value})}
                  placeholder="Enter translated title..."
                  className="w-full p-2 border rounded"
                />
                <p className="text-xs text-gray-600 mt-1">
                  {isAppInterface ? 
                    'This will be included in the YAML metadata' : 
                    'This will be used as the download filename'}
                </p>
              </div>

              {/* Translation sections */}
              {isAppInterface ? (
                // Special rendering for App Interface with three sections
                <>
                  {/* SECTION 1: Interface Terms */}
                  <div className="border-2 border-blue-300 rounded-lg overflow-hidden">
                    <div className="bg-blue-200 p-3">
                      <h3 className="font-bold text-blue-900">Interface Terms</h3>
                      <p className="text-sm text-blue-800">UI strings and labels shown throughout the app</p>
                    </div>
                    <div className="bg-blue-50 p-4 space-y-4">
                      {file.content.filter(item => item.type === 'interface').map((item) => {
                        const hasValue = fileTranslations[item.id] && fileTranslations[item.id].trim().length > 0;
                        return (
                          <div key={item.id} className={'p-4 border rounded ' + (hasValue ? 'bg-white border-green-300' : 'bg-white border-gray-300')}>
                            <div className="text-xs inline-block px-2 py-1 rounded mb-2 font-medium bg-blue-600 text-white">
                              {item.yamlKey}
                            </div>
                            <div className="p-2 bg-gray-50 border rounded mb-2 italic text-gray-600">
                              {item.text}
                            </div>
                            <div className="flex items-center gap-2 mb-2">
                              <input
                                type="checkbox"
                                id={`na-${item.id}`}
                                checked={fileTranslations[item.id] === '[N/A]'}
                                onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.checked ? '[N/A]' : '')}
                                className="rounded"
                              />
                              <label htmlFor={`na-${item.id}`} className="text-sm text-gray-600">
                                Mark as Not Applicable
                              </label>
                            </div>
                            <textarea
                              value={fileTranslations[item.id] === '[N/A]' ? '' : (fileTranslations[item.id] || '')}
                              onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.value)}
                              placeholder="Enter translation..."
                              className="w-full p-2 border rounded"
                              rows={2}
                              disabled={fileTranslations[item.id] === '[N/A]'}
                            />
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* SECTION 2: Metadata */}
                  <div className="border-2 border-yellow-300 rounded-lg overflow-hidden mt-6">
                    <div className="bg-yellow-200 p-3">
                      <h3 className="font-bold text-yellow-900">Metadata</h3>
                      <p className="text-sm text-yellow-800">App headers and copyright information</p>
                    </div>
                    <div className="bg-yellow-50 p-4 space-y-4">
                      {file.content.filter(item => item.type === 'metadata').map((item) => {
                        const hasValue = fileTranslations[item.id] && fileTranslations[item.id].trim().length > 0;
                        return (
                          <div key={item.id} className={'p-4 border rounded ' + (hasValue ? 'bg-white border-green-300' : 'bg-white border-gray-300')}>
                            <div className="text-xs inline-block px-2 py-1 rounded mb-2 font-medium bg-yellow-700 text-white">
                              {item.yamlKey}
                            </div>
                            <div className="p-2 bg-gray-50 border rounded mb-2 italic text-gray-600">
                              {item.text}
                            </div>
                            <div className="flex items-center gap-2 mb-2">
                              <input
                                type="checkbox"
                                id={`na-${item.id}`}
                                checked={fileTranslations[item.id] === '[N/A]'}
                                onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.checked ? '[N/A]' : '')}
                                className="rounded"
                              />
                              <label htmlFor={`na-${item.id}`} className="text-sm text-gray-600">
                                Mark as Not Applicable
                              </label>
                            </div>
                            <textarea
                              value={fileTranslations[item.id] === '[N/A]' ? '' : (fileTranslations[item.id] || '')}
                              onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.value)}
                              placeholder="Enter translation..."
                              className="w-full p-2 border rounded"
                              rows={2}
                              disabled={fileTranslations[item.id] === '[N/A]'}
                            />
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* SECTION 3: Table of Contents */}
                  <div className="border-2 border-green-300 rounded-lg overflow-hidden mt-6">
                    <div className="bg-green-200 p-3">
                      <h3 className="font-bold text-green-900">Table of Contents</h3>
                      <p className="text-sm text-green-800">Translate the navigation menu titles - filenames will be auto-generated from your translations (e.g., "Die Zehn Gebote" â†’ die-zehn-gebote.html)</p>
                    </div>
                    <div className="bg-green-50 p-4 space-y-4">
                      {file.content.filter(item => item.type === 'toc' && item.subKey === 'title').map((item) => {
                        const hasValue = fileTranslations[item.id] && fileTranslations[item.id].trim().length > 0;
                        return (
                          <div key={item.id} className={'p-4 border rounded ' + (hasValue ? 'bg-white border-green-300' : 'bg-white border-gray-300')}>
                            <div className="text-xs inline-block px-2 py-1 rounded mb-2 font-medium bg-green-700 text-white">
                              {item.yamlKey}
                            </div>
                            <div className="p-2 bg-gray-50 border rounded mb-2 italic text-gray-600">
                              {item.text}
                            </div>
                            <div className="flex items-center gap-2 mb-2">
                              <input
                                type="checkbox"
                                id={`na-${item.id}`}
                                checked={fileTranslations[item.id] === '[N/A]'}
                                onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.checked ? '[N/A]' : '')}
                                className="rounded"
                              />
                              <label htmlFor={`na-${item.id}`} className="text-sm text-gray-600">
                                Mark as Not Applicable
                              </label>
                            </div>
                            <textarea
                              value={fileTranslations[item.id] === '[N/A]' ? '' : (fileTranslations[item.id] || '')}
                              onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.value)}
                              placeholder="Enter translation..."
                              className="w-full p-2 border rounded"
                              rows={2}
                              disabled={fileTranslations[item.id] === '[N/A]'}
                            />
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </>
              ) : (
                // Regular rendering for other files
                file.content.map((item) => {
                  const hasValue = fileTranslations[item.id] && fileTranslations[item.id].trim().length > 0;
                  const isHeader = item.type === 'header' || item.type === 'subheader';
                  const isQuestion = item.type === 'question';
                  const badgeColor = isHeader ? 'bg-blue-600 text-white' : 
                                     isQuestion ? 'bg-purple-600 text-white' : 
                                     'bg-blue-100 text-blue-800';
                  const originalTextStyle = isHeader ? 'text-lg font-semibold text-gray-800' : 
                                            isQuestion ? 'italic' : '';

                  return (
                    <div key={item.id} className={'p-4 border rounded ' + (hasValue ? 'bg-green-50' : 'bg-gray-50')}>
                      <div className={'text-xs inline-block px-2 py-1 rounded mb-2 font-medium ' + badgeColor}>{item.type}</div>
                      <div className={'p-2 bg-white border rounded mb-2 italic text-gray-600 ' + (item.type === 'description' ? 'whitespace-pre-wrap' : '')}>
                        <span className={originalTextStyle}>
                          {item.text
                            .replace(/^#{1,5}\s*/, '')
                            .replace(/_/g, '')
                            .replace(/\\n/g, item.type === 'description' ? '\n' : ' ')}
                        </span>
                      </div>
                      <div className="flex items-center gap-2 mb-2">
                        <input
                          type="checkbox"
                          id={`na-${item.id}`}
                          checked={fileTranslations[item.id] === '[N/A]'}
                          onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.checked ? '[N/A]' : '')}
                          className="rounded"
                        />
                        <label htmlFor={`na-${item.id}`} className="text-sm text-gray-600">
                          Mark as Not Applicable (section is skipped in export)
                        </label>
                      </div>
                      <textarea
                        value={fileTranslations[item.id] === '[N/A]' ? '' : (fileTranslations[item.id] || '')}
                        onChange={(e) => handleTranslationChange(currentFile, item.id, e.target.value)}
                        placeholder="Enter translation..."
                        className="w-full p-2 border rounded"
                        rows={4}
                        disabled={fileTranslations[item.id] === '[N/A]'}
                      />
                    </div>
                  );
                })
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<TranslationWorkstation />);
    </script>
</body>
</html>
